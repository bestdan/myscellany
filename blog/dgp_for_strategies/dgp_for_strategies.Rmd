---
title: "Front-testing strategies"
author: "Daniel Egan"
date: "11/12/2017"
output: 
  html_document: 
    theme: cosmo
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
rm(list=ls())
if(!require(pacman)) install.packages("pacman")

pacman::p_load(ggplot2, scales, dplyr, knitr, janitor, ggridges, here, reshape2)

knitr::opts_chunk$set(echo = FALSE, warnings = FALSE, message = FALSE)

load(here::here("blog", "dgp_for_strategies", "data","dgp_for_strategies.RData")) # ~240MB of Data

light_blue_trans <- adjustcolor("light blue", alpha.f = 0.65)     
```

This RMD supports the post "Frontesting"
Draft [here](https://docs.google.com/document/d/1NykeONtH70vBF2z6c5LGIVbHAw-iPqx_7ghWGVcmvj8/edit#). 


## Simulating a regime switching market
Each line below is a simulation of a market environment. The underlying pattern is a mix of 'good' and 'bad' markets. 

- "Good" markets have a mean return of `r good_er`% and volatility of `r good_vol`%. 
- "Bad" markets have a mean return of `r bad_er`% and volatility of `r bad_vol`%. 
- Once you are in a "good" market, there is a `r percent(good_to_bad_transition_prob)` chance of transitioning to a 'bad' market. 
- Once you are in a "bad" market, there is a `r percent(bad_to_good_transition_prob)` chance of transitioning to a 'good' market. 
- So there is persistence. 

This is a pretty simple and straighforward way of modelling a regime switching model. I use these parameters to generate `r comma(sims)` market scenarios. The cumulative returns are plotted below for 200 of the runs. 


```{r}
nice_term_breaks <- seq(0, nobs, length.out = 11)
nice_term_breaks_labs <- nice_term_breaks/( 252)

market_sim_returns_alternative_df <- melt(market_sim_returns_alternative)
market_sim_returns_alternative_cumul <- melt(apply(market_sim_returns_alternative, 2, function(x) cumprod(x+1)))

ggplot(market_sim_returns_alternative_cumul %>% filter(Var2 <200)) + 
  geom_line(aes(x=Var1, y=value, group = Var2), color = adjustcolor("dark green",alpha.f = 0.2 ))  + 

  ylab("Growth of $1") + xlab("Years") + 
  scale_y_continuous(label = dollar) + scale_x_continuous(breaks = nice_term_breaks, labels = nice_term_breaks_labs )
```

We can see the underlying relationship between regimes and returns in one simulated outcome. The green line below are the cumulative returns in the scenario, and the blue shading indicates a 'good' market. It's worth noting that even 'good' markets can have negative returns, and even 'bad' markets can have positive ones. 
```{r}

mc_market_sim_states_df <- as.data.frame(mc_market_sim_states)
mc_market_sim_states_df$day <- 1:nrow(mc_market_sim_states_df)

mc_market_sim_states_df_long <- melt(mc_market_sim_states_df, id.vars = "day")
names(mc_market_sim_states_df_long) <- c("day", "scenario", "value")
mc_market_sim_states_df_long$scenario <- as.numeric(mc_market_sim_states_df_long$scenario)

ymin <- 0.98
ymax <- 1.13
mc_market_sim_states_df_long$value_numeric <- ifelse(mc_market_sim_states_df_long$value == "good", ymax, ymin)


ggplot() +
  geom_ribbon(data=filter(mc_market_sim_states_df_long, scenario==4), aes(x=day, ymin = ymin, ymax=value_numeric), fill=adjustcolor("blue", 0.3), size = 0.2) + 
  geom_line(data = mc_market_sim_returns_df_long %>% filter(scenario ==4), 
            aes(x=day, y=value), color = "dark green")  + 
  ylab("Growth of $1") + xlab("Years") + 
  scale_y_continuous(label = dollar) + scale_x_continuous(breaks = nice_term_breaks, labels = nice_term_breaks_labs ) + theme_minimal() + theme(legend.position = c(0,0))



```

## Our strategy

Since the DGP has some persistence in good versus bad market states, we're going to test a simple backwards looking strategy. 

> If the trailing `r window` day returns are above `r percent(threshold_p)` annualized, we assume we're in a "good" market, and invest. If they are beneath `r percent(threshold_p)`, we assume we're in a "bad" market, and don't invest. We earn no return when not invested. 

I'll compare this to always being invested. In every case we'll run both strategies through the exact same market scenario in each case.

Over all our `r comma(sims)` scenarios, this generates the following number of signals to invest or not. 

Here are a few example runs comparing the active and passive outcomes. You can see the active strategy having no growth after a period of down/flat days.  

```{r}

ggplot(cumul_values_all %>% filter(simulation_id %in% c(1:3) & day <= 252 & world == "alternative")) + 
  geom_line(aes(x=day, y=value, group=strategy, color = strategy)) + facet_grid(simulation_id ~ .) + 

  ylab("Value") + xlab("Days") + 
  scale_x_continuous(breaks = seq(1, 252, 22)) + 
  geom_vline(xintercept = window, col="dark grey")
```

## Results
Over the full ten years, the active strategy outperforms quite nicely, across scenarios. The scatter plot shows that distribution plot is actually being unkind: in every scenario, the market timing strategy performed better. 

```{r }

final_values_comp <- cumul_values_all %>% filter(day == nobs & world == "alternative")

ggplot(final_values_comp) + geom_density(aes(x=value, group = strategy, fill=strategy), alpha = 0.5)

```

#### Interim outcomes
Of course, over shorter periods of time the alpha has less time to accumulate. At the end of the first year the active strategy is generally outperforming. 

```{r}
interim <- 252 # One year

year1_values_comp <- cumul_values_all %>% filter(day == interim & world == "alternative")

kable(year1_values_comp %>% group_by(strategy) %>% summarize(mean(value)))

ggplot(year1_values_comp) + 
  geom_density(aes(x=value, group = strategy, fill=strategy), alpha = 0.5, color=NA) + 
  scale_x_continuous(label = dollar)

year1_values_comp_wide <- reshape(year1_values_comp, direction = "wide", 
                                  idvar = "simulation_id", timevar = "strategy" )


year1_values_comp_wide <- year1_values_comp_wide %>% mutate(premium = value.active - value.passive) 
year1_values_win_rate <-  prop.table(table(sign(year1_values_comp_wide$premium)))
```

The distributions under-estimate the success ratio. This plot shows the ending value of the passive strategy in versus the active strategy _for each scenario_. In only `r percent(year1_values_win_rate[1])` of outcomes does the passive win.

```{r}
lims <- c(0.98, 1.05)

ggplot(year1_values_comp_wide) + 
  geom_point(aes(x=value.baseline, y=value.active), color = "blue", alpha = 0.5) + 
  geom_abline(intercept = 0, slope = 1, col="dark grey") + 
  coord_cartesian(xlim=lims, ylim=lims) + 
  scale_x_continuous(label = dollar) + scale_y_continuous(label = dollar) +
  ylab("Value of active strategy") + xlab('Value of baseline strategy')


year1_values_comp_wide <- year1_values_comp_wide %>% mutate(premium = value.active - value.baseline) 

ggplot(year1_values_comp_wide) + 
  geom_density(aes(x=premium), fill = light_blue_trans ,color=NA) + 
  geom_vline(xintercept = 0, col="dark grey") + scale_x_continuous(label = percent)
```

We can see the effect of time on the strategy, as in the first year there is still a chance the active strategy doesn't work, but the active strategy increases it's hit ratio and magnitude as time goes on. 


```{r}

cumul_values_all_wide_alternative <- reshape(filter(cumul_values_all, world == "alternative"), direction = "wide", 
                                  idvar = c("simulation_id", "day"), timevar = "strategy")

cumul_values_all_wide_alternative   <- cumul_values_all_wide_alternative %>% mutate(premium = value.active - value.baseline) 

dayToYear <- function(x){
  (as.numeric(x))/252
}

ggplot(cumul_values_all_wide_alternative %>% filter(day %in% round(seq(252, nobs, 252)))) +
  geom_density_ridges2(aes(x=premium, y=as.factor(day), scale=1), fill=light_blue_trans, color = NA) + 
  geom_vline(xintercept = 0, col="dark grey") + scale_x_continuous(label=percent) + 
  scale_y_discrete(labels = dayToYear) + 
  ylab("Years") + xlab("Activ outperformance") + coord_flip()

```


```{r}
ggplot(cumul_values_all_wide_alternative %>% filter(day %in% round(seq(252, nobs, 252)))) +
  geom_density_ridges2(aes(x=value.baseline, y=as.factor(day), scale=1), fill=light_blue_trans, color = NA) + 
  geom_vline(xintercept = 1, col="dark grey") + scale_x_continuous(label=percent) + 
  scale_y_discrete(labels = dayToYear) + 
  ylab("Years") + xlab("Baseline raw performance") + coord_flip()
```


```{r}
win_ratio <- cumul_values_all_wide_alternative %>% group_by(day) %>% summarize(win_rate = mean(sign(premium)))

kable(filter(win_ratio, day %in% c(c(0, 30, 90, 120, 180, 240), seq(252, 252 * 5, 252))))

ggplot(filter(win_ratio, day <= 252 * 5)) +
  geom_area(aes(x=day, y=win_rate), fill="light blue") + 
  geom_hline(yintercept = 0.5, col="dark grey") + scale_y_continuous(label=percent) + 
  scale_x_continuous(breaks = seq(0, 252 * 5, 252), labels = dayToYear) +
  xlab("Years") + ylab("Strategy Win Ratio") 

```


## But what if we're wrong?
This section looks at the strategies in a similar risk/return environment, but _without_ the opportunity for arbitrage. Basically the NULL. 


This is all just goofy. The random DGP is finding the active strategy is way better? 

```{r}
ggplot(cumul_values_all %>% filter(simulation_id %in% c(1:3) & day <= 252 & world == "null")) + 
  geom_line(aes(x=day, y=value, group=strategy, color = strategy)) + facet_grid(simulation_id ~ .) + 
  ylab("Value") + xlab("Days") + 
  scale_x_continuous(breaks = seq(1, 252, 22)) + 
  geom_vline(xintercept = window, col="dark grey")
```


### How good is the strategy at detecting the regimes
Compare actual market environments vs perceived signals. Note that this is more a sensitivity analysis style approach. It's trivial to tune the parameters perfectly - we've pre-identified them! 
But what if we're slightly off? What if our window or thresholds are off?

```{r}
# signals <- res_market_true_strategy_true$signals
# signals[1:40, 1:10]
# ggplot(cumul_values_all_wide %>% filter(Var1 %in% round(seq(1, nobs, 252)))) +
#   geom_density_ridges(aes(x=premium, y=as.factor(Var1), scale=1), fill=adjustcolor("dark blue", alpha.f = 0.6), color=NA) + 
#   geom_vline(xintercept = 0, col="white") 
```

## But what if we're wrong? 
What is the impact of our strategy if we're wrong about how the world works? How much harm might we cause? We can also test that using a DGP approach. 

Let's run compare an active vs passive approach when we're wrong about how the world works. What about when there is no regime switching. 

How many false-positives does the strategy see? How often does it react to them?

>>> It's funny, through the course of writing this document up, I could feel myself getting hopeful that I'd beat a market-beating strategy... even though I knew I'd set it up to tell me that!! **Beware confirmation bias**. 

```{r}
final_values_comp <- cumul_values_all %>% filter(day == nobs & world == "null")
ggplot(final_values_comp) + geom_density(aes(x=value, group = strategy, fill=strategy), alpha = 0.5)

```
