---
title: "DGP and Strategy Testing"
author: "Daniel Egan"
date: "11/12/2017"
output: 
  html_document: 
    theme: cosmo
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
if(!require(pacman)) install.packages("pacman")
pacman::p_load(ggplot2, scales, dplyr, knitr, janitor, ggridges, here)

knitr::opts_chunk$set(echo = FALSE, warnings = FALSE, message = FALSE)

load(here::here("blog", "dgp_for_strategies", "data","dgp_for_strategies.RData")) # ~240MB of Data

light_blue_trans <- adjustcolor("light blue", alpha.f = 0.65)     
```

## Simulating a regime switching market
Each line below is a simulation of a market environment. The underlying pattern is a mix of 'good' and 'bad' markets. 

- "Good" markets have a mean return of `r good_er`% and volatility of `r good_vol`%. 
- "Bad" markets have a mean return of `r bad_er`% and volatility of `r bad_vol`%. 
- Once you are in a "good" market, there is a `r percent(good_to_bad_transition_prob)` chance of transitioning to a 'bad' market. 
- Once you are in a "bad" market, there is a `r percent(bad_to_good_transition_prob)` chance of transitioning to a 'good' market. 
- So there is persistence. 

This is a pretty simple and straighforward way of modelling a regime switching model. I use these parameters to generate `r comma(sims)` market scenarios. The cumulative returns are plotted below for 200 of the runs. 


```{r}
nice_term_breaks <- seq(0, nobs, length.out = 11)
nice_term_breaks_labs <- nice_term_breaks/( 252)
ggplot(mc_market_sim_returns_df_long %>% filter(Var2 <200)) + 
  geom_line(aes(x=Var1, y=value, group = Var2), color = adjustcolor("dark green",alpha.f = 0.2 ))  + 
  ylab("Growth of $1") + xlab("Years") + 
  scale_y_continuous(label = dollar) + scale_x_continuous(breaks = nice_term_breaks, labels = nice_term_breaks_labs )
```

## Our strategy

Since the DGP has some persistence in good versus bad market states, we're going to test a simple backwards looking strategy. 

> If the trailing 22 day returns are above 2% (annualized), we assume we're in a "good" market, and invest. If they are beneath 2%, we assume we're in a "bad" market, and don't invest. We earn no return when not invested. 

I'll compare this to always being invested. In every case we'll run both strategies through the exact same market scenario in each case.

Over all our `r comma(sims)` scenarios, this generates the following number of signals to invest or not. 

```{r}
# temp <- tabyl(as.vector(signals))
# temp[,1] <- ifelse(temp[,1] == 1, "Buy", "Sell")
# temp[,2] <- comma(temp[,2])
# temp[,3] <- percent(temp[,3])
# kable(temp)
```

Here are a few example runs comparing the active and passive outcomes. You can see the active strategy having no growth after a period of down/flat days.  

```{r}
ggplot(cumul_values_all %>% filter(Var2 %in% c(1:3) & Var1 <= 252)) + 
  geom_line(aes(x=Var1, y=value, group=strategy, color = strategy)) + facet_grid(Var2 ~ .) + 
  ylab("Value") + xlab("Days") + 
  scale_x_continuous(breaks = seq(1, 252, 22)) + 
  geom_vline(xintercept = window, col="dark grey")

ggplot(cumul_values_all %>% filter(Var2 %in% c(1) & Var1 <= 252)) + 
  geom_line(aes(x=Var1, y=value, group=strategy, color = strategy)) + 
  ylab("Value") + xlab("Days") + 
  scale_x_continuous(breaks = seq(1, 252, 22)) + 
  geom_vline(xintercept = window, col="dark grey")
```

## Results
Over the full ten years, the active strategy outperforms quite nicely, across scenarios. The scatter plot shows that distribution plot is actually being unkind: in every scenario, the market timing strategy performed better. 

```{r cars}
final_values_comp <- cumul_values_all %>% filter(Var1 == nobs)

ggplot(final_values_comp) + geom_density(aes(x=value, group = strategy, fill=strategy), alpha = 0.5)
final_values_comp_wide <- reshape(final_values_comp, direction = "wide", 
                                  idvar = "Var2", timevar = "strategy" )

```

#### Interim outcomes
Of course, over shorter periods of time the alpha has less time to accumulate. At the end of the first year the active strategy

```{r}
interim <- 252 # One year
year1_values_comp <- cumul_values_all %>% filter(Var1 == interim)
year1_values_comp %>% group_by(strategy) %>% summarize(mean(value))

ggplot(year1_values_comp) + geom_density(aes(x=value, group = strategy, fill=strategy), alpha = 0.5)

year1_values_comp_wide <- reshape(year1_values_comp, direction = "wide", 
                                  idvar = "Var2", timevar = "strategy" )

lims <- c(0.95, 1.08)

ggplot(year1_values_comp_wide) + 
  geom_point(aes(x=value.passive, y=value.active), color = "blue", alpha = 0.5) + 
  geom_abline(intercept = 0, slope = 1, col="dark grey") + 
  coord_cartesian(xlim=lims, ylim=lims) + 
  scale_x_continuous(label = dollar) + scale_y_continuous(label = dollar)

year1_values_comp_wide <- year1_values_comp_wide %>% mutate(premium = value.active - value.passive) 


ggplot(year1_values_comp_wide) + 
  geom_density(aes(x=premium), fill = light_blue_trans ,color=NA) + 
  geom_vline(xintercept = 0, col="dark grey") + scale_x_continuous(label = percent)
```

We can see the effect of time on the strategy, as in the first year it's a coin flip, but becomes stronger as time goes on. 


```{r}
#cumul_values_all_wide  %>% group_by(Var1, Var2) %>%
cumul_values_all_wide <- reshape(cumul_values_all, direction = "wide", 
                                  idvar = c("Var1", "Var2"), timevar = "strategy" )
cumul_values_all_wide   <- cumul_values_all_wide %>% mutate(premium = value.active - value.passive) 
dayToYear <- function(x){
  (as.numeric(x))/252
}

ggplot(cumul_values_all_wide %>% filter(Var1 %in% round(seq(252, nobs, 252)))) +
  geom_density_ridges2(aes(x=premium, y=as.factor(Var1), scale=1), fill=light_blue_trans, color = NA) + 
  geom_vline(xintercept = 0, col="dark grey") + scale_x_continuous(label=percent) + 
  scale_y_discrete(labels = dayToYear) + 
  ylab("Years") + xlab("Strategy outperformance %")

```


```{r}
ggplot(cumul_values_all_wide %>% filter(Var1 %in% round(seq(252, nobs, 252)))) +
  geom_density_ridges2(aes(x=value.passive, y=as.factor(Var1), scale=1), fill=light_blue_trans, color = NA) + 
  geom_vline(xintercept = 1, col="dark grey") + scale_x_continuous(label=percent) + 
  scale_y_discrete(labels = dayToYear) + 
  ylab("Years") + xlab("Strategy outperformance %")
```
